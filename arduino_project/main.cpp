#include <Arduino.h>
#include <ArduinoBLE.h>

#define BLE_UUID_DATA_SERVICE "202d3e06-252d-40bd-8dc6-0b7bfe15b99f"
#define BLE_UUID_LEAD_I_CHARACTERISTIC "4ccf588c-c839-4ec7-9954-94611cc77895"
#define BLE_UUID_LEAD_II_CHARACTERISTIC "7c90374c-9246-4fa2-b396-299d83992ac6"
#define BLE_UUID_LEAD_III_CHARACTERISTIC "44ab8765-80b6-442f-8953-f18e3375549c"
#define BLE_UUID_LEAD_VI_CHARACTERISTIC "f34748fb-c879-49f6-9719-aea577d5d182"
#define BLE_UUID_ALL_LEADS_CHARACTERISTIC "a0855912-29ea-4b12-a704-c813bdeb351b"
#define BLE_PERIPHERAL_NAME "Kompression"
#define SAMPLES_LENGTH 10
#define BYTES_TO_SEND 20

class Ewma {

public:
    double alpha;
    double output;
    bool hasInitial = false;

    Ewma(double alpha) {
        this->alpha = alpha;
    }

    double filter(double input) {
        if (hasInitial) {
            output = alpha * (input - output) + output;
        } else {
            output = input;
            hasInitial = true;
        }
        return output;
    }
};

// An alpha value closer to 0 will make the data almost flat, closer to 1 will not filter as much
Ewma ewmaFilter(0.8);

int16_t leadIDataToSend[SAMPLES_LENGTH];
int leadIDataToSendIndex = 0;
int16_t leadIIDataToSend[SAMPLES_LENGTH];
int leadIIDataToSendIndex = 0;
int16_t leadIIIDataToSend[SAMPLES_LENGTH];
int leadIIIDataToSendIndex = 0;
int16_t leadVIDataToSend[SAMPLES_LENGTH];
int leadVIDataToSendIndex = 0;
int16_t allLeadsDataToSend[8];
int allLeadsDataToSendIndex = 0;

BLEService sensorDataService(BLE_UUID_DATA_SERVICE);
BLECharacteristic leadISensorCharacteristic(BLE_UUID_LEAD_I_CHARACTERISTIC, BLERead | BLENotify, BYTES_TO_SEND);
BLECharacteristic leadIISensorCharacteristic(BLE_UUID_LEAD_II_CHARACTERISTIC, BLERead | BLENotify, BYTES_TO_SEND);
BLECharacteristic leadIIISensorCharacteristic(BLE_UUID_LEAD_III_CHARACTERISTIC, BLERead | BLENotify, BYTES_TO_SEND);
BLECharacteristic leadVISensorCharacteristic(BLE_UUID_LEAD_VI_CHARACTERISTIC, BLERead | BLENotify, BYTES_TO_SEND);
BLECharacteristic allLeadsCharacteristic(BLE_UUID_ALL_LEADS_CHARACTERISTIC, BLERead | BLENotify, 16);

int16_t goodData[] = {1720, 1883, 2024, 1530, 2093, 2426, 1897, 1944, 2016, 1327, 1946, 1857, 2026, 1715, 1961, 1370, 2383, 1950, 1855, 1838, 1449, 1256, 2416, 1687, 1473, 2183, 1449, 2044, 2042, 1734, 1962, 2042, 1894, 1448, 1958, 2055, 1800, 1954, 1936, 2041, 1307, 2071, 1752, 1547, 2055, 1387, 2042, 1794, 708, 1075, 1925, 1964, 1909, 2262, 2261, 1860, 2048, 2040, 1857, 1729, 2196, 2239, 1743, 2093, 2038, 1586, 1761, 2209, 2233, 1534, 2124, 1538, 1500, 2023, 2024, 1522, 1858, 1583, 1839, 1923, 1597, 1371, 1910, 1863, 1901, 2091, 1723, 1863, 2387, 1222, 2180, 1914, 1504, 1863, 1889, 2066, 2009, 1946, 1391, 1890, 1850, 1312, 1331, 2002, 2016, 1540, 2609, 1942, 1359, 2097, 2079, 1861, 2081, 1987, 2165, 2410, 1623, 2444, 3113, 3444, 2849, 3654, 3543, 3323, 3247, 2486, 1556, 1724, 1171, 498, 0, 718, 727, 258, 300, 1280, 1569, 1611, 1658, 1830, 1840, 1346, 2158, 2135, 1738, 2219, 1651, 1139, 1936, 2191, 2124, 2276, 1266, 2129, 2134, 1920, 2168, 2067, 2072, 2074, 2173, 1881, 2108, 2215, 2099, 2345, 1886, 2127, 2224, 1718, 1708, 2397, 1925, 1866, 2257, 1025, 2472, 2474, 1984, 1872, 2310, 2213, 2259, 2493, 2198, 2342, 2200, 2481, 2573, 2495, 1399, 2479, 2546, 2837, 1463, 2655, 3145, 2573, 2593, 2294, 2536, 2855, 2825, 1472, 2595, 2507, 2597, 2713, 2796, 2470, 1927, 2547, 2252, 1519, 2726, 2136, 2565, 2496, 2211, 1950, 2996, 2478, 2047, 2264, 2307, 1725, 2261, 1839, 2049, 2152, 1646, 548, 2397, 1871, 1889, 1693, 1567, 1651, 1129, 1859, 1717, 1498, 1671, 1491, 1485, 1511, 1688, 1603, 1452, 1602, 1705, 1665, 1211, 1444, 1829, 1421, 1611, 1681, 1693, 1216, 1641, 1853, 1828, 1351, 1674, 982, 1845, 1449, 1786, 1670, 578, 1989, 2194, 1919, 1579, 1663, 1520, 1997, 2028, 1227, 1913, 1792, 809, 1318, 1863, 1940, 1703, 1808, 1898, 1213, 1853, 1930, 1551, 1745, 1651, 2144, 1528, 1867, 1755, 1211, 1892, 1950, 1961, 1088, 1807, 1774, 1366, 1490, 2082, 1970, 1646, 1540, 2005, 1776, 1778, 2176, 874, 1938, 1785, 2351, 1530, 2102, 1948, 1975, 1332, 1842, 822, 2046, 1855, 2016, 1661, 2016, 1999, 1947, 1890, 1998, 1404, 1967, 2078, 941, 1937, 1966, 1775, 1473, 1948, 1604, 1761, 2048, 1983, 1947, 2088, 2038, 1418, 2047, 2369, 2467, 1884, 1839, 2051, 2141, 1976, 1871, 2072, 2086, 1887, 1712, 2009, 1576, 2358, 2068, 2171, 2149, 2120, 1611, 2065, 2151, 1584, 1966, 2356, 1482, 2077, 2119, 1521, 1812, 2328, 1201, 2024, 2015, 1722, 1402, 2084, 1281, 1762, 1841, 1828, 2123, 1569, 1993, 1943, 1860, 1232, 1617, 2061, 2015, 2295, 1933, 1136, 2004, 1462, 1766, 1981, 1281, 1503, 2039, 2290, 1498, 1881, 2101, 1717, 1193, 2062, 1941, 2000, 1539, 1894, 1944, 2059, 2232, 2025, 1224, 2068, 2089, 2200, 1790, 2630, 3138, 2975, 3304, 3072, 3510, 3012, 3611, 3852, 3496, 2587, 2604, 1239, 1516, 928, 186, 617, 807, 651, 0, 972, 1743, 1183, 1423, 2143, 1138, 1668, 1919, 1734, 1577, 1882, 2144, 1167, 2192, 2238, 2049, 2070, 2191, 1901, 1751, 2429, 2273, 1735, 2116, 2024, 2197, 1336, 2319, 2191, 2202, 1512, 2126, 1862, 1537, 2302, 2420, 1975, 2116, 2225, 2302, 1991, 2282, 2019, 1674, 2176, 2401, 2196, 2113, 2480, 2292, 1992, 2293, 2031, 2419, 1816, 2336, 2304, 1566, 2376, 2348, 2503, 2305, 2559, 2544, 2528, 2665, 1820, 2627, 2598, 2245, 2407, 2426, 2828, 2243, 2402, 2429, 2655, 2740, 2264, 2244, 2812, 2531, 1988, 2641, 2298, 2579, 1982, 2637, 2759, 2165, 2550, 2526, 2751, 2932, 2886, 2828, 2421, 4095, 2356, 1965, 2468, 2251, 1874, 2179, 1950, 1654, 1644, 2165, 2276, 1734, 1492, 1770, 1929, 1703, 1835, 1727, 1288, 1579, 1557, 1747, 1235, 1677, 1431, 1660, 1581, 0, 562, 1720, 1697, 3219, 1768, 1774, 1647, 1779, 1411, 1672, 1687, 1130, 1807, 1874, 1499, 1765, 890, 1864, 1890, 1882, 1488, 934, 1979, 1922, 1656, 1926, 1804, 1570, 649, 2012, 1796, 1729, 1893, 1923, 1153, 2007, 1875, 1416, 1891, 1855, 1738, 1281, 1900, 1911, 1847, 1819, 2100, 1712, 2156, 1738, 1076, 1825, 2078, 1902, 2236, 1956, 1531, 1476, 1871, 1875, 1553, 2000, 1985, 1792, 1349, 1961, 1348, 1893, 1859, 1617, 1786, 2027, 2081, 2018, 1820, 1900, 2072, 2015, 1837, 1928, 1996, 1344, 1874, 2164, 1589, 1900, 1843, 850, 2091, 1915, 1431, 1328, 2255, 2058, 1783, 2018, 2220, 1784, 2254, 2279, 1881, 1996, 2256, 2252, 1715, 2272, 2103, 2060, 2174, 2140, 1165, 1891, 2299, 2102, 1779, 2117, 1606, 2289, 2099, 957, 2006, 499, 1851, 1191, 1899, 1915, 1462, 2000, 1387, 421, 2075, 2348, 2103, 1956, 1602, 1988, 2042, 1938, 1943, 1987, 1581, 1620, 2130, 2169, 1895, 2011, 1935, 1508, 2124, 2043, 1894, 1413, 2151, 2069, 2046, 2009, 2295, 1983, 2252, 2164, 2250, 2010, 2419, 3035, 3099, 3464, 3183, 3455, 3488, 3487, 2844, 3010, 2446, 2155, 1350, 1472, 1169, 0, 402, 543, 1302, 0, 1024, 1116, 1286, 1441, 1798, 825, 1759, 1868, 1937, 1228, 2010, 1408, 2327, 2100, 1645, 2036, 2048, 1676, 1562, 2211, 2223, 1621, 2092, 0, 1291, 1922, 2323, 2105, 1701, 2025, 2119, 1779, 2279, 2199, 2063, 2167, 2174, 2215, 2168, 1807, 2183, 2238, 2048, 1961, 2419, 2230, 1844, 1834, 2379, 2368, 2034, 1644, 2414, 1863, 2311, 2708, 2303, 1650, 2773, 2414, 2405, 1936, 2418, 2395, 2004, 2076, 2643, 2571, 2112, 2003, 2592, 2546, 1678, 2451, 2573, 2586, 2460, 2526, 2779, 2834, 2806, 1823, 2620, 2632, 2838, 2805, 2711, 2308, 2655, 2891, 2117, 2985, 2772, 2321, 2427, 2413, 2193, 2413, 2216, 1756, 2116, 2102, 1293, 2061, 1990, 1684, 1390, 1599, 943, 1455, 1328, 1509, 1375, 954, 1440, 1467, 1658, 1492, 1391, 1503, 1622, 1706, 1572, 1071, 1650, 1621, 1041, 1511, 1468, 1615, 1001, 1682, 1784, 576, 1782, 1629, 1360, 1865, 1853, 1390, 1580, 1987, 1240, 1885, 1779, 1430, 261, 2019, 1831, 769, 1751, 1964, 1791, 1877, 1528, 1230, 1471, 1816, 672, 1951, 1940, 1620, 1805, 1720, 341, 1818, 2010, 1818, 1869, 1831, 1884, 1316, 1389, 2025, 1787, 1237, 1544, 1847, 1615, 2050, 2035, 1452, 977, 1774, 1993, 2016, 1907, 1709, 1725, 1911, 1890, 1032, 1321, 1826, 1158, 1901, 2221, 1372, 2263, 2011, 2025, 1986, 1967, 1623, 1876, 2141, 2007, 1991, 1932, 1972, 923, 2109, 1977, 2014, 2004, 1694, 1642, 2144, 2022, 1708, 1965, 1388, 1941, 2187, 1700, 1989, 1915, 1957, 1568, 2200, 2390, 2115, 1818, 1985, 1573, 2137, 2024, 1510, 2117, 2135, 2287, 1182, 2394, 2234, 2083, 2162, 1532, 2235, 2224, 2065, 2290, 2216, 2290, 1757, 2014, 1990, 1561, 1834, 2080, 1238, 1401, 1858, 1875, 53, 1786, 2072, 2093, 2091, 1994, 1626, 1581, 1780, 2173, 1859, 1230, 1598, 1326, 2005, 2115, 1349, 1784, 2031, 2015, 2886, 1621, 2879, 1598, 2017, 2049, 1295, 2158, 2037, 2267, 1980, 1480, 2834, 2700, 1876, 2775, 3383, 3438, 2734, 2839, 3640, 3164, 3568, 3333, 3238, 2231, 2367, 1960, 1697, 924, 398, 605, 853, 822, 361, 1108, 1197, 615, 1411, 1387, 1301, 1676, 1787, 2141, 1732, 2047, 1672, 2387, 2126, 1631, 2219, 2154, 1811, 1881, 2600, 1999, 1226, 1527, 2261, 2100, 1973, 2076, 1991, 1592, 1908, 2251, 2248, 1868, 1760, 1790, 2177, 2263, 3009, 2079, 1858, 2150, 2047, 2093, 1605, 2147, 2212, 1782, 2180, 2303, 2099, 1484, 2295, 2208, 2146, 1860, 2316, 1625, 2455, 2450, 2333, 793, 2408, 2385, 2335, 1968, 2547, 2325, 1944, 2389, 2431, 2139, 2617, 2636, 2011, 2602, 2530, 1907, 2701, 2704, 2189, 2700, 2943, 2681, 1987, 2714, 2983, 2631, 2601, 2744, 2290, 2732, 2704, 2292, 2537, 2255, 2429, 2151, 2016, 2284, 1783, 1507, 2205, 1739, 1588, 1884, 1715, 1813, 1778, 1740, 1368, 1522, 1488, 1535, 943, 1432, 1650, 1285, 1454, 1494, 1487, 1686, 954, 1130, 1568, 875, 1635, 1572, 1575, 1593, 1527, 1495, 1907, 1730, 1399, 1647, 1482, 1969, 1716, 1487, 1631, 1613, 1126, 1227, 1874, 1706, 1722, 1578, 1832, 1871, 1856, 1577, 1814, 1830, 1999, 922, 1826, 1295, 1938, 2243, 1603, 2016, 1950, 1718, 1772, 1808, 1984, 1725, 1324, 1868, 1919, 1295, 1944, 1847, 1832, 1863, 1447, 1929, 1999, 1272, 1936, 1955, 1326, 1635, 2064, 1965, 1465, 2012, 1911, 1196, 1924, 2038, 1904, 1674, 2119, 2052, 1844, 1572, 1535, 1828, 1333, 1813, 2444, 1816, 1431, 1876, 2197, 1974, 1916, 2059, 1914, 1451, 1478, 1989, 2080, 1708, 1967, 2117, 2047, 1973, 2008, 1848, 1862, 2138, 1593, 2036, 1536, 1998, 2010, 1932, 1872, 2034, 2152, 1408, 1981, 1894, 1720, 2154, 2098, 1817, 2108, 2198, 1646, 2184, 2379, 2175, 2224, 1825, 1884, 1700, 2276, 2166, 2053, 2199, 2197, 751, 2345, 1483, 2079, 2100, 2425, 1505, 2071, 2122, 2040, 1412, 2036, 1802, 1705, 1902, 1606, 1971, 1408, 2072, 2144, 2102, 1948, 1775, 1550, 1880, 1516, 2244, 1969, 1490, 1967, 2163, 1962, 1991, 2063, 1479, 1806, 2069, 2006, 1069, 2067, 2117, 1441, 2254, 1997, 2192, 2267, 2765, 2354, 2463, 3429, 3498, 3268, 2431, 3747, 3283, 3714, 3550, 3017, 2263, 2280, 2098, 836, 1047, 8, 12, 578, 671, 541, 1120, 1452, 736, 1394, 1421, 1159, 1896, 1944, 1141, 2906, 1578, 1611, 2231, 1429, 2034, 1894, 1629, 2225, 2168, 1288, 1676, 2092, 1999, 1390, 2147, 1758, 1809, 2070, 2456, 1598, 2026, 2251, 2158, 2082, 2212, 1836, 1302, 2144, 1777, 1667, 2140, 2319, 2047, 2079, 1715, 2102, 2167, 1667, 2220, 2327, 2452, 1360, 2369, 2134, 1283, 2442, 2403, 2211, 1951, 2366, 2519, 2082, 2151, 2527, 1203, 2549, 2495, 1305, 2584, 2742, 2172, 2596, 2666, 2305, 2736, 2632, 2190, 2598, 2617, 2524, 1483, 2876, 2735, 2087, 2478, 1639, 2469, 2610, 3205, 2288, 2441, 2590, 2360, 2375, 2289, 2156, 2092, 2405, 1980, 1020, 2059, 2071, 1623, 1804, 1314, 824, 1834, 1665, 1332, 1362, 1528, 1426, 1263, 1718, 2011, 1215, 1582, 1489, 1508, 954, 1784, 1664, 1836, 1663, 1626, 1117, 1547, 1772, 1839, 1016, 1511, 1783, 1739, 1690, 1615, 1927, 1569, 1772, 1776, 1700, 1243, 2004, 1867, 1363, 1869, 1153, 1140, 1987, 1874, 741, 1820, 1779, 1858, 1827, 1895, 1647, 1809, 1718, 1209, 1497, 1936, 2000, 1919, 1398, 2000, 1952, 1308, 1864, 1756, 1761, 1614, 1865, 2290, 1512, 1799, 2071, 1612, 982, 1997, 1695, 1879, 2042, 1781, 2000, 2094, 1868, 1489, 1917, 1866, 1424, 1940, 1976, 1619, 1934, 1775, 1422, 1993, 1840, 1417, 1903, 1861, 1844, 1327, 2032, 1480, 1019, 2007, 1457, 1966, 2051, 2058, 1765, 1882, 1933, 2120, 2084, 1242, 1841, 1709, 1752, 1521, 1724, 2044, 1501, 2354, 1871, 1919, 1443, 2113, 1836, 1503, 1935, 2131, 1395, 2227, 2130, 2166, 1519, 2030, 2055, 2036, 1488, 2235, 1711, 2180, 2203, 1543, 2177, 2232, 1990, 1492, 2090, 2158, 1708, 2248, 1838, 1759, 1935, 2065, 1133, 1437, 2149, 2187, 1403, 1925, 1884, 2015, 2364, 1988, 2039, 1548, 1782, 1882, 2025, 1943, 1880, 1620, 1967, 1952, 1963, 1836, 1965, 1972, 974, 1964, 1992, 1459, 1913, 2063, 1785, 2015, 1976, 1373, 1544, 2481, 1999, 1344, 1972, 2066, 1588, 2007, 2151, 1884, 2376, 2744, 2493, 3019, 3240, 3664, 3677, 3993, 3336, 3524, 3207, 1983, 2543, 2031, 1748, 1140, 1275, 1024, 708, 0, 871, 0, 863, 1172, 1271, 1235, 1450, 1532, 1560, 1222, 1732, 1016, 1904, 2237, 2263, 1765, 2162, 1904, 667, 2169, 1558, 2080, 2070, 2357, 2471, 1931, 2182, 2259, 2430, 2186, 2324, 1923, 1883, 2055, 2049, 2047, 2290, 2297, 2238, 2112, 2250, 1723, 1899, 2383, 2064, 2272, 2164, 1323, 2052, 2251, 2016, 2242, 2167, 1893, 2480, 2484, 2349, 2421, 2308, 2489, 2085, 2694, 2115, 2559, 1796, 2472, 2353, 2552, 1964, 2775, 2635, 2463, 2605, 2146, 2799, 2615, 2703, 2751, 2589, 1675, 2737, 2312, 2540, 2149, 411, 2871, 2515, 3218, 2395, 2879, 2603, 1886, 2327, 1256, 1750, 2323, 1649, 1449, 1891, 2077, 827, 1689, 1898, 374, 1353, 1640, 1888, 1164, 917, 1576, 1576, 1631, 943, 1595, 1541, 1127, 1485, 1693, 1548, 1141, 1782, 1361, 1483, 1634, 1719, 1801, 1417, 1811, 1759, 1428, 1755, 734, 1963, 1893, 1970, 1869, 1810, 1172, 1980, 1940, 1606, 1804, 1606, 1304, 1127, 2036, 1846, 1961, 1787, 2143, 1632, 1719, 1983, 1850, 2141, 1646, 1351, 1964, 1858, 1894, 1813, 1830, 1962, 2067, 1661, 2032, 1845, 1901, 1404, 1986, 1424, 1608, 1938, 1887, 1199, 2133, 1961, 1560, 1519, 2472, 1600, 1953, 1983, 174, 1902, 1914, 1626, 1459, 1989, 1537, 2127, 1991, 1121, 2604, 2085, 1915, 809, 2004, 1981, 1541, 1958, 1399, 1969, 1852, 1991, 2001, 2083, 1343, 1902, 1977, 1790, 2071, 1750, 1603, 1658, 2113, 1308, 1172, 1923, 2120, 1427, 1882, 1914, 1973, 1036, 2056, 1964, 1831, 2038, 1260, 548, 2040, 1955, 1713, 1535, 2076, 1618, 2003, 1994, 2016, 1980, 2071, 2049, 1010, 2190, 2083, 2037, 1676, 2215, 1989, 2295, 2212, 2274, 1874, 2037, 1639, 2133, 2237, 2162, 1845, 2025, 2278, 1530, 2181, 2203, 1757, 1433, 2048, 2110, 1529, 2308, 1520, 1979, 1950, 2035, 1667, 1935, 2060, 2007, 1563, 2144, 1968, 1491, 1501, 2153, 2110, 1913, 1404, 1900, 2239, 1304, 2141, 2171, 2001, 1498, 1974, 2068, 2082, 1532, 1970, 1950, 2043, 2047, 2232, 1927, 2075, 2248, 2044, 1607, 2040, 1577, 2178, 2595, 1987, 2895, 2823, 2853, 2931, 3605, 3614, 3352, 3322, 2896, 3410, 3425, 2942, 2026, 1772, 1189, 412, 831, 497, 208, 777, 714, 847, 642, 1227, 1555, 1216, 1311, 1496, 1749, 1429, 1618, 2105, 1600, 1335, 1894, 1689, 1910, 2153, 1662, 2136, 1998, 1917, 1969, 2545, 2195, 1679, 2131, 2156, 1380, 2072, 1982, 2184, 1377, 2177, 2057, 2156, 2031, 2218, 1598, 2093, 2140, 1997, 1344, 2157, 2239, 1692, 2058, 2266, 1881, 2239, 2179, 2302, 2347, 2061, 2520, 2476, 302, 1794, 2260, 2372, 1900, 1665, 2587, 2408, 2373, 2386, 2493, 1858, 2603, 2520, 2285, 2655, 2636, 2700, 2714, 2708, 2640, 2586, 2818, 2184, 2696, 2962, 2839, 2406, 2605, 2772, 2838, 2840, 2850, 2719, 2664, 2700, 2818, 2747, 2067, 2449, 2344, 1472, 2253, 2340, 2179, 2054, 1986, 1908, 1641, 1519, 2119, 1546, 1190, 1562, 1646, 1689, 1527, 1524, 1029, 1441, 1359, 539, 1456, 1694, 992, 1394, 1364, 1693, 1039, 1055, 1724, 1432, 426, 1502, 908, 1376, 1705, 1697, 1431, 1473, 1904, 1200, 1420, 1896, 1330, 1573, 1688, 1707, 1279, 1055, 1013, 1515, 1425, 1908, 1816, 691, 1932, 1872, 1936, 1353, 1685, 1166, 1989, 2021, 1896, 1775, 2080, 1354, 1351, 2023, 1744, 1430, 1918, 2086, 1891, 1236, 1921, 1878, 1834, 1797, 1721, 999, 2002, 1901, 1920, 1580, 1977, 1870, 1312, 1906, 2185, 1429, 2074, 1922, 1795, 2140, 1990, 1054, 1518, 2418, 1767, 1023, 1975, 1823, 1847, 1881, 1708, 1107, 1137, 2013, 1783, 1906, 1663, 1316, 2318, 2036, 1695, 1716, 2043, 2145, 2273, 1966, 1745, 1526, 1902, 1840, 1459, 2006, 2169, 2078, 1983, 2011, 1814, 2036, 2329, 2018, 1029, 1965, 2003, 1853, 1840, 2145, 854, 1769, 1985, 2043, 1720, 2187, 2007, 1968, 2146, 1308, 1776, 2101, 1737, 1509, 1902, 2097, 1431, 2107, 2155, 1569, 1980, 1472, 1476, 2873, 1806, 2071, 1995, 1936, 2086, 2025, 2083, 2152, 2240, 2317, 1588, 2403, 1917, 2964, 2021, 2062, 1613, 2123, 2232, 1663, 1998, 2077, 1386, 1689, 2221, 1796, 1513, 1991, 1864, 1910, 1594, 2035, 1775, 1869, 1719, 1851, 1855, 1364, 1648, 2427, 2026, 1590, 1985, 1947, 1352, 1711, 1913, 2149, 1797, 1418, 1907, 1932, 1448, 2071, 1945, 1396, 1983, 1810, 2106, 1767, 1938, 1962, 2093, 1472, 1915, 1658, 1629, 2233, 1236, 1590, 1996, 2099, 1885, 2275, 2544, 2201, 2996, 3161, 3419, 3520, 3663, 3401, 3746, 3512, 3532, 1940, 1148, 1080, 388, 632, 686, 740, 267, 645, 1299, 1575, 1581, 1050, 1794, 1845, 2119, 1231, 1969, 1899, 2008, 1922, 3186, 1682, 2161, 2079, 1578, 1866, 1979, 1397, 2376, 2237, 1744, 1975, 2085, 1842, 1146, 2178, 2211, 1593, 3360, 2144, 1500, 1984, 2369, 2215, 2502, 1860, 2110, 1697, 2240, 1858, 2167, 2315, 1703, 1818, 2355, 2123, 1896, 2286, 2554, 2483, 2577, 1982, 2061, 2346, 2404, 2079, 2537, 2628, 1959, 2540, 2399, 1665, 2546, 2583, 2277, 2779, 2662, 2667, 2631, 2821, 2304, 2527, 2778, 2681, 1798, 3024, 2874, 2921, 2790, 2650, 2739, 2906, 2797, 2572, 2027, 2566, 2706, 1525, 2594, 2833, 2483, 2212, 1411, 2318, 2256, 2174, 1767, 1729, 1056, 1810, 1604, 1076, 1637, 1410, 1542, 1588, 1515, 1373, 1478, 1503, 1471, 947, 1697, 1538, 1469, 1427, 1488, 1124, 1619, 1640, 1439, 1505, 2101, 645, 1703, 1632, 1570, 1557, 1367, 1343, 1760, 1731, 1240, 1662, 1886, 765, 1896, 1413, 1749, 1920, 1290, 933, 1997, 1499, 1589, 1821, 1836, 1189, 2039, 1185, 1819, 1776, 55, 1691, 2021, 1981, 1731, 1757, 1884, 1038, 1932, 1932, 1660, 1972, 1753, 1399, 1321, 2039, 1885, 1092, 1921, 1951, 1635, 1594, 1954, 1881, 1196, 1482, 1865, 1340, 1673, 1879, 1713, 1781, 1899, 1940, 1472, 2038, 1815, 1474, 1862, 1895, 1299, 2057, 2060, 2052, 1766, 1869, 782, 1941, 1831, 1576, 1959, 1820, 1988, 1433, 2052, 1554, 1778, 1862, 1882, 1532, 2080, 2327, 1948, 1619, 2036, 2029, 1424, 2025, 1972, 1457, 1866, 1921, 1717, 1411, 2097, 1936, 1931, 1960, 1928, 1227, 2084, 2001, 1408, 1884, 2266, 1919, 2142, 2040, 1131, 2123, 1965, 1516, 2147, 1864, 1853, 2252, 1489, 1614, 2207, 2229, 2315, 1728, 2156, 1703, 2252, 2160, 1221, 2204, 1918, 1398, 1604, 2274, 2301, 2042, 2067, 2067, 1427, 1614, 2128, 1685, 2065, 1758, 1386, 1182, 1964, 1922, 1850, 1959, 1622, 1968, 2137, 2039, 1561, 1893, 1916, 2103, 1631, 2189, 1991, 1831, 1503, 2039, 1983, 2092, 1961, 1739, 2063, 1578, 1749, 2106, 2072, 3113, 2409, 2037, 1376, 2075, 2063, 1964, 1955, 2245, 2248, 2945, 3054, 2941, 3077, 3412, 3325, 3972, 3638, 3713, 2958, 2760, 2488, 896, 1733, 1436, 371, 548, 521, 161, 795, 1162, 1017, 496, 1045, 1173, 2068, 2140, 2073, 1721, 2040, 2263, 2093, 2764, 2105, 2036, 2111, 2188, 2194, 2081, 1438, 2187, 2137, 1590, 2288, 2105, 1427, 2228, 2359, 1046, 2192, 2279, 2266, 1776, 1727, 2071, 1423, 2392, 2416, 2265, 2238, 2250, 2290, 1667, 2308, 2018, 2239, 2335, 2400, 2462, 2227, 2331, 2047, 1898, 1710, 2632, 2500, 2237, 2407, 2486, 802, 2347, 2619, 2118, 2467, 2624, 2684, 2608, 2709, 2449, 2611, 2620, 2707, 1849, 2787, 2637, 2610, 2666, 1820, 2666, 2090, 2099, 2559, 2466, 1729, 2470, 2412, 1606, 2066, 2239, 2070, 1814, 1319, 1975, 1695, 1790, 1746, 1116, 1750, 1183, 872, 1625, 1498, 1136, 2035, 1743, 1423, 1035, 1586, 1556, 1614, 1429, 1610, 1351, 1483, 1614, 1647, 1827, 1314, 1672, 1708, 1552, 629, 1701, 1894, 2143, 1500, 1643, 1225, 1804, 2026, 1824, 1299, 1836, 1310, 736, 1935, 1615, 1847, 1787, 1279, 2034, 2077, 1844, 1641, 1753, 2111, 2191, 1736, 1582, 1923, 1949, 1753, 1678, 1939, 1512, 1816, 1722, 1503, 1978, 2130, 1927, 1762, 1933, 1861, 1654, 1967, 1934, 1843, 1225, 1968, 1981, 2138, 1596, 1948, 1977, 1466, 1833, 2169, 1922, 1641, 2007, 1958, 2102, 2201, 1961, 1929, 1942, 1972, 1692, 1921, 2060, 1532, 1539, 1875, 1906, 1349, 1989, 2063, 1857, 1557, 2124, 2006, 1036, 1924, 2206, 1372, 1893, 1926, 1920, 1754, 2244, 2140, 1616, 2215, 2210, 1269, 2202, 2024, 1999, 2187, 2112, 1288, 2223, 2496, 2264, 2164, 2194, 1587, 1660, 2206, 2309, 1920, 2215, 1987, 1409, 2119, 1922, 1609, 1907, 1987, 1166, 1504, 2024, 2002, 2006, 1896, 677, 1852, 2063, 1779, 2043, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

#define INTERVAL 1250 // 2.5 milliseconds per sample for 400 Hz - 1.25 ms for the BLE write cmd

bool setupBleMode();

int16_t leadIRawData = 0;
int16_t leadIIRawData = 0;
int16_t leadIIIRawData = 0;
int16_t leadVIRawData = 0;

int arrayIndex = 0;
unsigned long startTime = 0;
uint32_t lastMicros = 0;
int allSamplesNumber = 0;

void setup() {
    Serial.begin(115200);

    setupBleMode();

    analogReadResolution(12);
}

void loop() {

    BLEDevice central = BLE.central();

    if (central) {
        Serial.print("Connected to central: ");
        Serial.println(central.address());

        startTime = micros();
        allSamplesNumber = 0;

        while (central.connected()) {

            if (micros() - lastMicros > INTERVAL) {

                lastMicros = micros();

                if (leadISensorCharacteristic.subscribed()) {
                    leadIRawData = goodData[arrayIndex];
                    // leadIRawData = int16_t(ewmaFilter.filter(double(goodData[array_index])));

                    arrayIndex++;
                    if (arrayIndex > 3273) {
                        arrayIndex = 0;
                    }

                    leadIDataToSend[leadIDataToSendIndex++] = leadIRawData;
                    allSamplesNumber++;

                    if (leadIDataToSendIndex >= SAMPLES_LENGTH) {
                        // uint32_t timer = micros();
                        leadISensorCharacteristic.writeValue(leadIDataToSend, sizeof(leadIDataToSend));
                        // Serial.print("Write took: ");
                        // Serial.println(micros() - timer);
                        leadIDataToSendIndex = 0;
                    }

                } else if (leadIISensorCharacteristic.subscribed()) {
                    leadIIRawData = analogRead(A0);

                    leadIIDataToSend[leadIIDataToSendIndex++] = leadIIRawData;
                    allSamplesNumber++;

                    if (leadIIDataToSendIndex >= SAMPLES_LENGTH) {
                        leadIISensorCharacteristic.writeValue(leadIIDataToSend, sizeof(leadIIDataToSend));
                        leadIIDataToSendIndex = 0;
                    }

                } else if (leadIIISensorCharacteristic.subscribed()) {
                    leadIIIRawData = analogRead(A0);

                    leadIIIDataToSend[leadIIIDataToSendIndex++] = leadIIIRawData;
                    allSamplesNumber++;

                    if (leadIIIDataToSendIndex >= SAMPLES_LENGTH) {
                        leadIIISensorCharacteristic.writeValue(leadIIIDataToSend, sizeof(leadIIIDataToSend));
                        leadIIIDataToSendIndex = 0;
                    }

                } else if (leadVISensorCharacteristic.subscribed()) {
                    leadVIRawData = analogRead(A0);

                    leadVIDataToSend[leadVIDataToSendIndex++] = leadVIRawData;
                    allSamplesNumber++;

                    if (leadVIDataToSendIndex >= SAMPLES_LENGTH) {
                        leadVISensorCharacteristic.writeValue(leadVIDataToSend, sizeof(leadVIDataToSend));
                        leadVIDataToSendIndex = 0;
                    }

                } else if (allLeadsCharacteristic.subscribed()) {
                    // Read from all 4 analog inputs and send data
                    allLeadsDataToSend[allLeadsDataToSendIndex++] = goodData[arrayIndex];
                    arrayIndex++;
                    if (arrayIndex > 3273) {
                        arrayIndex = 0;
                    }

                    // allLeadsDataToSend[allLeadsDataToSendIndex++] = goodData[arrayIndex];
                    // arrayIndex++;
                    // if (arrayIndex > 3273) {
                    //     arrayIndex = 0;
                    // }

                    allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);
                    allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);
                    allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);

                    // allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);
                    // allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);
                    // allLeadsDataToSend[allLeadsDataToSendIndex++] = analogRead(A0);

                    allSamplesNumber++;

                    if (allLeadsDataToSendIndex >= 8) {
                        allLeadsCharacteristic.writeValue(allLeadsDataToSend, sizeof(allLeadsDataToSend));
                        allLeadsDataToSendIndex = 0;
                    }

                } else {
                    // No leads subscribed
                    allSamplesNumber = 0;
                    startTime = micros();
                }

                if (allSamplesNumber >= 5000) {
                    Serial.println("5000 samples sent");
                    float elapsedTimePerSampleUs = (micros() - startTime) / 5000;
                    Serial.print("Time per sample (us): ");
                    Serial.println(elapsedTimePerSampleUs);
                    Serial.print("Max sampling freq (Hz): ");
                    Serial.println(pow(10, 6) / elapsedTimePerSampleUs);
                    Serial.print("\n");
                    allSamplesNumber = 0;
                    startTime = micros();
                }
            }
        }

        // Serial.print("Disconnected from central: ");
        // Serial.println(central.address());
    }
}

bool setupBleMode() {
    if (!BLE.begin()) {
        return false;
    }

    // set advertised local name and service UUID:
    BLE.setDeviceName(BLE_PERIPHERAL_NAME);
    BLE.setLocalName(BLE_PERIPHERAL_NAME);
    BLE.setAdvertisedService(sensorDataService);

    // BLE add characteristics
    sensorDataService.addCharacteristic(leadISensorCharacteristic);
    sensorDataService.addCharacteristic(leadIISensorCharacteristic);
    sensorDataService.addCharacteristic(leadIIISensorCharacteristic);
    sensorDataService.addCharacteristic(leadVISensorCharacteristic);
    sensorDataService.addCharacteristic(allLeadsCharacteristic);

    // add service
    BLE.addService(sensorDataService);

    // Set the interval for the communication in units of 1.25 ms
    // We want 400 Hz so that is 1 sample every 2.5ms, minimum should be 1 * 1.25 = 1.25ms and maximum can be 2 * 1.25 = 2.5ms
    BLE.setConnectionInterval(1, 1);

    // start advertising
    BLE.advertise();

    return true;
}
